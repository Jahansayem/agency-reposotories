<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wavezly Todo - Outlook Add-in</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      padding: 16px;
      min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* Logo */
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: #0033A0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .logo h1 {
      font-size: 18px;
      font-weight: 700;
      color: #0033A0;
    }

    .subtitle {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* Buttons */
    .primary-btn {
      width: 100%;
      padding: 14px 20px;
      background: #D4A853;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .primary-btn:hover {
      background: #c49943;
    }

    .primary-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .secondary-btn {
      padding: 12px 20px;
      background: white;
      color: #64748b;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .secondary-btn:hover {
      background: #f1f5f9;
      color: #1e293b;
    }

    /* Loading */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e2e8f0;
      border-top-color: #0033A0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading-view {
      text-align: center;
      padding: 40px 0;
    }

    #loading-view p {
      color: #64748b;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 6px;
    }

    .form-group textarea,
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      color: #1e293b;
      background: white;
      transition: border-color 0.2s;
    }

    .form-group textarea:focus,
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0033A0;
      box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .context-box {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 20px;
    }

    .context-box small {
      color: #64748b;
      font-size: 12px;
      line-height: 1.5;
    }

    .button-row {
      display: flex;
      gap: 12px;
    }

    .button-row .secondary-btn {
      flex: 0 0 auto;
    }

    .button-row .primary-btn {
      flex: 1;
    }

    /* Success */
    #success-view {
      text-align: center;
      padding: 40px 0;
    }

    .success-icon {
      width: 60px;
      height: 60px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      font-weight: bold;
      margin: 0 auto 16px;
    }

    #success-view h2 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #1e293b;
    }

    #success-view p {
      color: #64748b;
      margin-bottom: 24px;
    }

    /* Error */
    .error-box {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      color: #dc2626;
      font-size: 13px;
    }

    /* Draft heading */
    #draft-view h2 {
      font-size: 16px;
      color: #1e293b;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Initial State -->
    <div id="initial-view">
      <div class="logo">
        <div class="logo-icon">B</div>
        <h1>Wavezly</h1>
      </div>
      <p class="subtitle">Convert this email into a task for your team</p>
      <button id="convert-btn" class="primary-btn">
        <span>&#10024;</span>
        Analyze Email with AI
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading-view" class="hidden">
      <div class="spinner"></div>
      <p>Analyzing email with AI...</p>
    </div>

    <!-- Draft Preview State -->
    <div id="draft-view" class="hidden">
      <h2>Review Task</h2>

      <div id="error-box" class="error-box hidden"></div>

      <div class="form-group">
        <label for="task-text">Task Description</label>
        <textarea id="task-text" rows="3" placeholder="What needs to be done?"></textarea>
      </div>

      <div class="form-group">
        <label for="assignee">Assign To</label>
        <select id="assignee">
          <option value="">Unassigned</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>

        <div class="form-group">
          <label for="due-date">Due Date</label>
          <input type="date" id="due-date">
        </div>
      </div>

      <div class="context-box">
        <small id="context-text">From email...</small>
      </div>

      <div class="button-row">
        <button id="cancel-btn" class="secondary-btn">Cancel</button>
        <button id="create-btn" class="primary-btn">Add Task</button>
      </div>
    </div>

    <!-- Success State -->
    <div id="success-view" class="hidden">
      <div class="success-icon">&#10003;</div>
      <h2>Task Created!</h2>
      <p>The task has been added and will appear in the todo app.</p>
      <button id="done-btn" class="primary-btn">Convert Another</button>
    </div>
  </div>

  <script>
    // Configuration - UPDATE THIS WITH YOUR DEPLOYED URL
    const API_BASE = window.location.origin + '/api/outlook';
    const API_KEY = 'bealer-outlook-addon-2025-secure-key';

    let currentDraft = null;
    let currentUserName = 'Outlook User';

    // Initialize when Office is ready
    Office.onReady(function(info) {
      if (info.host === Office.HostType.Outlook) {
        initializeAddin();
      } else {
        // For testing outside Outlook
        initializeAddin();
      }
    });

    async function initializeAddin() {
      // Load users for dropdown
      await loadUsers();

      // Get current user name from Office profile
      try {
        if (Office.context && Office.context.mailbox && Office.context.mailbox.userProfile) {
          currentUserName = Office.context.mailbox.userProfile.displayName || 'Outlook User';
        }
      } catch (e) {
        console.log('Could not get user profile:', e);
      }

      // Set up event listeners
      document.getElementById('convert-btn').addEventListener('click', analyzeEmail);
      document.getElementById('cancel-btn').addEventListener('click', resetView);
      document.getElementById('create-btn').addEventListener('click', createTask);
      document.getElementById('done-btn').addEventListener('click', resetView);
    }

    async function loadUsers() {
      try {
        const response = await fetch(API_BASE + '/users', {
          headers: { 'X-API-Key': API_KEY }
        });
        const data = await response.json();

        if (data.success && data.users) {
          const select = document.getElementById('assignee');
          // Clear existing options except first
          while (select.options.length > 1) {
            select.remove(1);
          }
          // Add users
          data.users.forEach(function(user) {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load users:', error);
      }
    }

    async function analyzeEmail() {
      showView('loading');
      hideError();

      try {
        let emailData = {
          subject: '',
          body: '',
          sender: '',
          receivedDate: new Date().toISOString()
        };

        // Try to get email content from Office.js
        if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
          const item = Office.context.mailbox.item;
          emailData.subject = item.subject || '';
          emailData.sender = item.from ? item.from.emailAddress : '';
          emailData.receivedDate = item.dateTimeCreated ? item.dateTimeCreated.toISOString() : emailData.receivedDate;

          // Get body asynchronously
          emailData.body = await new Promise(function(resolve) {
            item.body.getAsync(Office.CoercionType.Text, function(result) {
              resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value : '');
            });
          });
        }

        // If we couldn't get any content, use test data
        if (!emailData.subject && !emailData.body) {
          emailData = {
            subject: 'Test Email - Q4 Budget Review',
            body: 'Hi Derek, Please have Sefra review the Q4 budget by Friday. This is urgent. Thanks, John',
            sender: 'john@example.com',
            receivedDate: new Date().toISOString()
          };
        }

        // Send to AI for parsing
        const response = await fetch(API_BASE + '/parse-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
          },
          body: JSON.stringify(emailData)
        });

        const data = await response.json();

        if (data.success) {
          currentDraft = data.draft;
          populateDraftForm(data.draft);
          showView('draft');
        } else {
          showError(data.error || 'Failed to analyze email. Please try again.');
          showView('initial');
        }
      } catch (error) {
        console.error('Error analyzing email:', error);
        showError('Failed to connect to server. Please check your connection.');
        showView('initial');
      }
    }

    function populateDraftForm(draft) {
      document.getElementById('task-text').value = draft.text || '';
      document.getElementById('priority').value = draft.priority || 'medium';
      document.getElementById('due-date').value = draft.dueDate || '';
      document.getElementById('context-text').textContent = draft.context || 'From email';

      // Set assignee if found
      const assigneeSelect = document.getElementById('assignee');
      if (draft.suggestedAssignee) {
        // Find matching option (case-insensitive)
        for (let i = 0; i < assigneeSelect.options.length; i++) {
          if (assigneeSelect.options[i].value.toLowerCase() === draft.suggestedAssignee.toLowerCase()) {
            assigneeSelect.value = assigneeSelect.options[i].value;
            break;
          }
        }
      } else {
        assigneeSelect.value = '';
      }
    }

    async function createTask() {
      const createBtn = document.getElementById('create-btn');
      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';
      hideError();

      const taskData = {
        text: document.getElementById('task-text').value.trim(),
        assignedTo: document.getElementById('assignee').value || null,
        priority: document.getElementById('priority').value,
        dueDate: document.getElementById('due-date').value || null,
        createdBy: currentUserName
      };

      if (!taskData.text) {
        showError('Please enter a task description.');
        createBtn.disabled = false;
        createBtn.textContent = 'Add Task';
        return;
      }

      try {
        const response = await fetch(API_BASE + '/create-task', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
          },
          body: JSON.stringify(taskData)
        });

        const data = await response.json();

        if (data.success) {
          showView('success');
        } else {
          showError(data.error || 'Failed to create task. Please try again.');
        }
      } catch (error) {
        console.error('Error creating task:', error);
        showError('Failed to connect to server. Please check your connection.');
      }

      createBtn.disabled = false;
      createBtn.textContent = 'Add Task';
    }

    function showView(view) {
      ['initial', 'loading', 'draft', 'success'].forEach(function(v) {
        const el = document.getElementById(v + '-view');
        if (el) {
          el.classList.toggle('hidden', v !== view);
        }
      });
    }

    function resetView() {
      currentDraft = null;
      hideError();
      showView('initial');
    }

    function showError(message) {
      const errorBox = document.getElementById('error-box');
      errorBox.textContent = message;
      errorBox.classList.remove('hidden');
    }

    function hideError() {
      const errorBox = document.getElementById('error-box');
      if (errorBox) {
        errorBox.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
